<!--suppress HtmlUnknownAttribute -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.15.24/dist/css/uikit.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/uikit@3.15.24/dist/js/uikit.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/uikit@3.15.24/dist/js/uikit-icons.min.js"></script>

<!--<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>-->
<script src="https://unpkg.com/petite-vue@0.2.2/dist/petite-vue.iife.js" defer init></script>

<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.14.3/dist/algoliasearch-lite.umd.js"
        integrity="sha256-dyJcbGuYfdzNfifkHxYVd/rzeR6SLLcDFYEidcybldM=" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/@algolia/autocomplete-js"></script>
<script>
    // const {createApp} = Vue

    import algoliasearch
        from 'https://cdn.jsdelivr.net/npm/algoliasearch@4.14.3/dist/algoliasearch-lite.esm.browser.js';

    const {autocomplete, getAlgoliaResults,} = window['@algolia/autocomplete-js'];
    const algoliasearch_client = algoliasearch('TTRQ0VJY4D', '99354995bfad26ed950bdb701bc56b6b');
    const algoliasearch_index = algoliasearch_client.initIndex('published-docs');

    // const autocompleteSearch = autocomplete({
    //     container: '#autocomplete',
    //     getSources() {
    //         return [
    //             {
    //                 sourceId: 'querySuggestions',
    //                 getItemInputValue: ({item}) => item.query,
    //                 getItems({query}) {
    //                     return getAlgoliaResults({
    //                         searchClient: algoliasearch_client,
    //                         queries: [
    //                             {
    //                                 indexName: 'published-docs',
    //                                 query,
    //                                 params: {
    //                                     hitsPerPage: 4,
    //                                 },
    //                             },
    //                         ],
    //                     });
    //                 },
    //                 templates: {
    //                     item({item, components}) {
    //                         return components.ReverseHighlight({hit: item, attribute: 'query'});
    //                     },
    //                 },
    //             },
    //         ];
    //     },
    // });

    const fade_away = ["uk-animation-fade", "uk-animation-reverse"];
    const slide_in = ["uk-animation-slide-right"];
    const shake = ["uk-animation-shake"];
    const big_shrink_icon = 'icon: shrink; ratio: 1.25';
    const big_expand_icon = 'icon: expand; ratio: 1.25';
    let first_time = true;
    // import MyComponent from 'analytics/my_component.js'

    const app = createApp({
        delimiters: ['[[', ']]'],
        data() {
            return {
                message: 'Hello Vue!',
                count: 0,
                current_page_content: null,
                found_tags: [],
                found_providers: [],
                provider: "apache-airflow-providers-snowflake",
                docs_content: "",
                search_content: "",
                search: ""
            }
        },
        // watch: {
        //     search(newSearch, oldSearch){
        //         // TODO - debounce
        //
        //     }
        // }
        methods: {
            get_description(provider) {
                for (const found_provider of this.found_providers) {
                    if (found_provider.package_name == provider) {
                        return found_provider.description
                    }
                }
                return "Description"
            },
            fetch_search() {
                // TODO - this doesn't work - needs JS to render afterwards
                let self = this;
                algoliasearch_index.search('query string', {
                    hitsPerPage: 10,
                }).then(({hits}) => {
                    console.log(hits);
                    self.search_content = hits;
                    UIkit.modal("#search-modal").toggle();
                });

                // const url = "https://docs.astronomer.io/search?q=" + encodeURIComponent(this.search);
                // console.log(url);
                // fetch(url)
                //     .then((response) => {
                //         if (response.ok) {
                //             response.text().then((data) => {
                //                 let parsed = new DOMParser().parseFromString(data, "text/html");
                //                 console.log(parsed);
                //                 self.search_content = parsed.querySelector("#__docusaurus main").innerHTML
                //             });
                //             UIkit.modal("#search-modal").toggle();
                //         }
                //     });
            }
        },
        mounted() {
            const tags_to_search_for = ["snowflake"]
            const current_page_content = $("body > div.container")[0].innerHTML;

            for (const tag in tags_to_search_for) {
                if (new RegExp(tag, 'i').test(current_page_content)) {
                    this.found_tags.concat(tag);
                }
            }

            // TODO - high level
            // TODO auth handshake to get cust info
            // TODO scan `page` and have an "On This Page"
            // TODO scan ``/providers` and have an "On This Airflow"


            // TODO - LOGIN
            // TODO - get centralized customer info (CICD, Secrets, Migration, etc)
            // https://github.com/astronomer/starship/blob/master/astronomer-starship/starship/templates/components/token_modal.html
            // "get token"  <a href="https://cloud.astronomer.io/token"
            // paste field, record in storage
            // localStorage.setItem('YourItem', response.data)
            // localStorage.getItem('YourItem')
            // sessionStorage.setItem('mode','dark');

            // TODO - inject docs
            // turn this into a component, that takes a URL
            fetch("https://docs.astronomer.io/astro/set-up-ci-cd").then(
                (response) => response.text().then(
                    (data) => this.docs_content = new DOMParser()
                        .parseFromString(
                            // convert relative links to absolute links back to the docs
                            data.replaceAll('href="/astro/', 'href="https://docs.astronomer.io/astro/'),
                            "text/html"
                        )
                        .querySelector("#docusaurus_skipToContent_fallback article div.markdown")
                        .outerHTML
                )
            );

            // TODO - lookup and quick docs

            // TODO - scan page for keywords

            // TODO - other maybe interesting routes?
            // http://localhost:8080/api/v1/config
            // http://localhost:8080/api/v1/eventLogs

            // Fetch /providers installed locally
            fetch(window.location.origin + '/api/v1/providers')
                .then((response) => {
                    if (response.ok) {
                        response.json().then((data) => {
                            if ("providers" in data) {
                                console.log(data);
                                this.found_providers = data['providers'];
                                console.log("found " + data['providers'].length + " providers");
                            }
                        })
                    } else {
                        console.log("Error requesting - /api/v1/providers")
                    }
                });
        }
    })
    app.mount('#clippy-container');

    function move_sidebar_under_header(header_selector = ".navbar", panel_id = "clippy-main") {
        const header_height = $(".navbar")[0].clientHeight + "px";
        let panel = document.getElementById(panel_id);
        panel.style.top = header_height;
    }

    $(window).resize(function () {
        move_sidebar_under_header();
    });

    UIkit.util.ready(function () {
        move_sidebar_under_header();

        const clippy_container = $("#clippy-container")
        const clippy_main = $("#clippy-main")
        const fullscreen_button = document.getElementById("fullscreen-button")
        const rocketship = $("#rocketship");

        // Rocketship - animate and toggle menu
        rocketship.attr("hidden", false);
        rocketship.addClass(slide_in.concat(shake));
        UIkit.util.on(clippy_container, 'beforeshow', function () {
            let remove = rocketship.hasClass(shake[0]) ? slide_in.concat(shake) : slide_in;
            rocketship.removeClass(remove);
            rocketship.addClass(fade_away);
            first_time = false;
        });
        UIkit.util.on(clippy_container, 'hidden', function () {
            if (!first_time) {
                rocketship.removeClass(fade_away);
                rocketship.addClass(slide_in);
            }
        });

        // Fullscreen button - expand and shrink content
        UIkit.util.on(fullscreen_button, 'click', function () {
            if (fullscreen_button.getAttribute('uk-icon').includes("expand")) {
                clippy_main.addClass("uk-width-5-6");
                fullscreen_button.setAttribute('uk-icon', big_shrink_icon);
            } else {
                clippy_main.removeClass("uk-width-5-6");
                fullscreen_button.setAttribute('uk-icon', big_expand_icon);
            }
        });
    });
</script>

<button id="rocketship" type="button" uk-toggle="target: #clippy-container"
        class="uk-button uk-button-link uk-position-center-right uk-margin-small-right" hidden>
    <!--    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="100px" height="100px"-->
    <!--         viewBox="0 0 400 400" version="1.1">-->
    <!--        <title>astronomer-monogram-reverse-on-purple</title>-->
    <!--        <defs>-->
    <!--            <linearGradient x1="20.007264%" y1="-5.53089117%" x2="82.1904169%" y2="89.3033953%" id="linearGradient-1">-->
    <!--                <stop stop-color="#DBCDF6" offset="0%"/>-->
    <!--                <stop stop-color="#FFFFFF" offset="100%"/>-->
    <!--            </linearGradient>-->
    <!--        </defs>-->
    <!--        <g id="astronomer-monogram-reverse-on-purple" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">-->
    <!--            <rect fill="#59418D" x="0" y="0" width="400" height="400"/>-->
    <!--            <g id="Group-3" transform="translate(50.000000, 50.000000)" fill="url(#linearGradient-1)">-->
    <!--                <path d="M163.336647,0.0815463606 C123.011468,1.38729488 85.6108842,18.3157153 58.0200254,47.751938 L58.0200254,47.751938 C1.06442291,108.518071 4.1651981,204.291755 64.9293177,261.248364 L64.9293177,261.248364 C86.2431202,281.224202 111.872839,293.782342 138.616019,299.085875 L138.616019,299.085875 L146.631724,279.043592 C122.246342,274.969294 98.7630034,263.93436 79.4113473,245.796839 L79.4113473,245.796839 C27.168319,196.825732 24.5024577,114.48203 73.4715507,62.2369878 L73.4715507,62.2369878 C97.1944944,36.9284204 129.351949,22.3698782 164.02224,21.248364 L164.02224,21.248364 C165.459872,21.201047 166.896498,21.1799054 168.330103,21.1799054 L168.330103,21.1799054 C194.480309,21.1799054 219.530143,28.9368771 240.865087,43.401792 L240.865087,43.401792 L248.892874,23.3272929 C224.927304,8.12040673 197.206575,0 168.344197,0 L168.344197,0 C166.678034,0 165.009857,0.0271821202 163.336647,0.0815463606 L163.336647,0.0815463606 Z M178.625079,76.7190174 L158.28782,76.7190174 L157.606253,76.7190174 L157.352553,77.3522601 L103.838006,211.137622 L103.28631,212.518876 L104.773272,212.518876 L126.370977,212.518876 L127.059591,212.518876 L127.308257,211.876573 L140.438227,178.11638 L198.143855,178.11638 L211.438932,211.881607 L211.689612,212.518876 L212.376212,212.518876 L234.737029,212.518876 L236.223992,212.518876 L235.671289,211.137622 L201.116774,124.750831 L200.864081,124.118595 L200.181507,124.118595 L178.561654,124.118595 L177.089793,124.118595 L177.623368,125.489782 L189.879484,156.990839 L148.866698,156.990839 L179.564373,78.0912111 L180.097948,76.7190174 L178.625079,76.7190174 Z"-->
    <!--                      id="Fill-1"/>-->
    <!--            </g>-->
    <!--        </g>-->
    <!--    </svg>-->
    <svg class="icon" width="75px" height="100px" viewBox="0 0 1024 1024"
         version="1.1"
         xmlns="http://www.w3.org/2000/svg" fill="#000000">
        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
        <g id="SVGRepo_iconCarrier">
            <path d="M662.72 462.784l136.448 169.408v173.248l-136.448-48.32zM342.72 457.344L206.272 626.816v173.248l136.448-48.384z"
                  fill="#3A7EB9"></path>
            <path d="M570.688 418.688l-142.848 1.152a266.496 266.496 0 0 1-20.288-0.576l3.712 448.64c0.256 28.928 94.272 130.048 94.272 130.048s93.888-102.656 93.632-131.584l-3.712-448.96a344.64 344.64 0 0 1-24.768 1.28z"
                  fill="#D48171"></path>
            <path d="M531.456 599.296l-63.04 0.576c-3.008 0-5.952-0.064-8.96-0.384l2.176 257.792c0.128 16.64 41.728 74.816 41.728 74.816s41.344-58.944 41.28-75.52l-2.176-257.92c-3.648 0.384-7.296 0.64-11.008 0.64z"
                  fill="#E9DF92"></path>
            <path d="M554.304 93.568a324.352 324.352 0 0 0-110.592 1.728L342.72 240.768v584.512c13.824-0.96 27.968-1.536 42.368-1.536h245.248c11.84 0 23.36 0.384 34.816 1.024V253.312L554.304 93.568z"
                  fill="#B5D5EB"></path>
            <path d="M541.44 94.144L500.416 35.008l-45.696 59.136v29.504h89.024v-29.504zM459.456 288.64h88.96v88.896h-88.96zM459.456 467.456h88.96v88.96h-88.96zM459.456 634.176h88.96v88.896h-88.96zM364.928 788.736h277.76v44.352h-277.76z"
                  fill="#3A7EB9"></path>
        </g>
    </svg>
</button>

<div id="app-container">
    <h1>AUTOCOMPLETE:</h1>
    <div id="autocomplete"></div>
</div>

<div id="clippy-container" class="uk-width-expand" uk-offcanvas="flip: true; mode: slide; container: body">
    <div id="clippy-main" class="uk-offcanvas-bar uk-width-2-5">
        <nav class="uk-navbar" style="box-shadow: none">
            <form class="uk-search uk-search-navbar" @submit.prevent>
                <span uk-search-icon class="uk-search-toggle"></span>
                <!--                <input class="uk-search-input" @keyup.enter="fetch_search()" v-model="search" type="search"-->
                <!--                       placeholder="Search docs..." aria-label="">-->
            </form>

            <button id="fullscreen-button"
                    class="uk-position-right uk-margin-small-top uk-margin-medium-right"
                    type="button" uk-icon="icon: expand; ratio: 1.25"></button>
            <button id="close-button" class="uk-offcanvas-close uk-close-large" type="button" uk-close></button>
        </nav>
        <hr>

        <div class="uk-margin">
            <div uk-form-custom="target: true">
                <select id="provider-dropdown" v-model="provider" class="uk-select uk-form-large"
                        aria-label="Providers Dropdown">
                    <option value="" disabled>Please select...</option>
                    <option v-for="item in found_providers" :value="item.package_name"
                            :label="item.package_name"></option>
                </select>
                <button class="uk-button uk-button-default" type="button" tabindex="-1">
                    <span uk-icon="icon: list"> </span>
                    <span class="uk-padding-remove-vertical uk-padding-small" id="provider-label">[[ provider ]]</span>
                    <span uk-icon="icon: chevron-down"> </span>
                </button>
            </div>
            <p class="uk-text-meta">[[ get_description(provider) ]]</p>
        </div>

        <ul uk-tab>
            <li class="uk-active"><a id="video" href="">Video</a></li>
            <li><a id="docs" href="">Docs</a></li>
        </ul>
        <ul class="uk-switcher">
            <li>
                <!--academy-->
                <iframe src="https://www.youtube-nocookie.com/embed/MUwPWqaJjvk?autoplay=0&amp;showinfo=0&amp;rel=0&amp;modestbranding=1&amp;playsinline=1"
                        allowfullscreen uk-responsive uk-video="autoplay: false"></iframe>
                <!--academy-->
                <!--                    <iframe src="//fast.wistia.net/embed/iframe/9vz3pyjr8p?controlsVisibleOnLoad=false&amp;autoPlay=false"-->
                <!--                            allowtransparency="true" frameborder="0" scrolling="no" class="wistia_embed"-->
                <!--                            name="wistia_embed"-->
                <!--                            allowfullscreen="" mozallowfullscreen="" webkitallowfullscreen="" oallowfullscreen=""-->
                <!--                            msallowfullscreen="" allow="fullscreen"></iframe>-->
                <!--                </div>-->
                Hello!
            </li>
            <li>
                <div class="uk-container">
                    <span v-html="docs_content"></span>
                </div>
            </li>
        </ul>
    </div>

    <div class="uk-flex-top" uk-modal>
        <div id="search-modal" class="uk-modal-dialog uk-margin-auto-vertical uk-overflow-auto">
            <button class="uk-modal-close-default" type="button" uk-close></button>

            <span v-html="search_content"></span>
        </div>
    </div>
</div>